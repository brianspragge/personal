#!/usr/bin/env bash
# ------------------------------------------------------------
# Symlink user config files from the repo into $HOME
# ------------------------------------------------------------
set -euo pipefail

# ------------------------------------------------------------------
# Helper: create parent dirs, back up old files, create symlink
# ------------------------------------------------------------------
link_file() {
    local src="$1"
    local dst="$2"

    if [[ ! -e "$src" ]]; then
        echo "WARNING: Source missing – skipping: $src"
        return 0
    fi

    mkdir -p "$(dirname "$dst")"

    if [[ -e "$dst" && ! -L "$dst" ]]; then
        local bak="${dst}.bak.$(date +%Y%m%d%H%M%S)"
        echo "Backing up: $dst → $bak"
        mv -- "$dst" "$bak"
    fi

    if ln -sf -- "$src" "$dst"; then
        if [[ "$(readlink -f "$dst")" == "$(realpath "$src")" ]]; then
            echo "Linked: $dst → $src"
        else
            echo "ERROR: symlink created but points elsewhere!"
            return 1
        fi
    else
        echo "ERROR: failed to create symlink $dst"
        return 1
    fi
}

# ------------------------------------------------------------------
# Base directory
# ------------------------------------------------------------------
BASE="$HOME/personal/omarchy/dev/user"

# ------------------------------------------------------------------
# All the files
# ------------------------------------------------------------------
# config files
link_file "$BASE/.config/alacritty/alacritty.toml" "$HOME/.config/alacritty/alacritty.toml"
# hypr
link_file "$BASE/.config/hypr/autostart.conf" "$HOME/.config/hypr/autostart.conf"
link_file "$BASE/.config/hypr/bindings.conf"  "$HOME/.config/hypr/bindings.conf"
link_file "$BASE/.config/hypr/monitors.conf"  "$HOME/.config/hypr/monitors.conf"
link_file "$BASE/.config/hypr/reference.conf" "$HOME/.config/hypr/reference.conf"

# files in .local/bin
link_file "$BASE/.local/bin/get-color"        "$HOME/.local/bin/get-color"
link_file "$BASE/.local/bin/gpg_crd_cmds.txt" "$HOME/.local/bin/gpg_crd_cmds.txt"
link_file "$BASE/.local/bin/gpgcli"           "$HOME/.local/bin/gpgcli"

# dot-files
link_file "$BASE/.bashrc"  "$HOME/.bashrc"
link_file "$BASE/.inputrc" "$HOME/.inputrc"
link_file "$BASE/.vimrc"   "$HOME/.vimrc"
echo "All symlinks processed."

# ------------------------------------------------------------------
# Activate Plymouth theme (requires sudo)
# ------------------------------------------------------------------
echo "In order to install charmander Plymouth theme"
echo "move charmander dir to /usr/share/plymouth/themes"
echo "and"
echo "sudo plymouth-set-default-theme -R charmander"

