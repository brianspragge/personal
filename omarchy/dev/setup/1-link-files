#!/usr/bin/env bash
# ------------------------------------------------------------
# Symlink user config files from the repo into $HOME
# ------------------------------------------------------------
set -euo pipefail

# ------------------------------------------------------------------
# Helper: create parent dirs, back up old files, create symlink
# ------------------------------------------------------------------
link_file() {
    local src="$1"
    local dst="$2"

    if [[ ! -e "$src" ]]; then
        echo "WARNING: Source missing – skipping: $src"
        return 0
    fi

    mkdir -p "$(dirname "$dst")"

    if [[ -e "$dst" && ! -L "$dst" ]]; then
        local bak="${dst}.bak.$(date +%Y%m%d%H%M%S)"
        echo "Backing up: $dst → $bak"
        mv -- "$dst" "$bak"
    fi

    if ln -sf -- "$src" "$dst"; then
        if [[ "$(readlink -f "$dst")" == "$(realpath "$src")" ]]; then
            echo "Linked: $dst → $src"
        else
            echo "ERROR: symlink created but points elsewhere!"
            return 1
        fi
    else
        echo "ERROR: failed to create symlink $dst"
        return 1
    fi
}

# ------------------------------------------------------------------
# Base directory
# ------------------------------------------------------------------
BASE="$HOME/personal/omarchy/dev/user"

# ------------------------------------------------------------------
# All the files
# ------------------------------------------------------------------
# config files
link_file "$BASE/.config/alacritty/alacritty.toml" "$HOME/.config/alacritty/alacritty.toml"
# hypr
link_file "$BASE/.config/hypr/autostart.conf" "$HOME/.config/hypr/autostart.conf"
link_file "$BASE/.config/hypr/bindings.conf"  "$HOME/.config/hypr/bindings.conf"
link_file "$BASE/.config/hypr/monitors.conf"  "$HOME/.config/hypr/monitors.conf"
link_file "$BASE/.config/hypr/reference.conf" "$HOME/.config/hypr/reference.conf"
# vimium
link_file "$BASE/.config/vimium/vimium-options(chromium).json"    "$HOME/.config/vimium/vimium-options(chromium).json"
link_file "$BASE/.config/vimium/vimium-options(zen-browser).json" "$HOME/.config/vimium/vimium-options(zen-browser).json"

# files in .local/bin
link_file "$BASE/.local/bin/get-color"        "$HOME/.local/bin/get-color"
link_file "$BASE/.local/bin/gpg_crd_cmds.txt" "$HOME/.local/bin/gpg_crd_cmds.txt"
link_file "$BASE/.local/bin/gpgcli"           "$HOME/.local/bin/gpgcli"

# files in .local/share
link_file "$BASE/.local/share/fonts/PressStart2P-Regular.ttf" "$HOME/.local/share/fonts/PressStart2P-Regular.ttf"

# dot-files
link_file "$BASE/.bashrc"  "$HOME/.bashrc"
link_file "$BASE/.inputrc" "$HOME/.inputrc"
link_file "$BASE/.vimrc"   "$HOME/.vimrc"


# ------------------------------------------------------------------
# Plymouth theme – charmander
# ------------------------------------------------------------------
link_file "$BASE/plymouth/themes/charmander/bullet.png"          "/usr/share/plymouth/themes/charmander/bullet.png"
link_file "$BASE/plymouth/themes/charmander/capslock.png"        "/usr/share/plymouth/themes/charmander/capslock.png"
link_file "$BASE/plymouth/themes/charmander/charmander.plymouth" "/usr/share/plymouth/themes/charmander/charmander.plymouth"
link_file "$BASE/plymouth/themes/charmander/entry.png"           "/usr/share/plymouth/themes/charmander/entry.png"
link_file "$BASE/plymouth/themes/charmander/keymap-render.png"   "/usr/share/plymouth/themes/charmander/keymap-render.png"
link_file "$BASE/plymouth/themes/charmander/lock.png"            "/usr/share/plymouth/themes/charmander/lock.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0001.png"   "/usr/share/plymouth/themes/charmander/throbber-0001.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0002.png"   "/usr/share/plymouth/themes/charmander/throbber-0002.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0003.png"   "/usr/share/plymouth/themes/charmander/throbber-0003.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0004.png"   "/usr/share/plymouth/themes/charmander/throbber-0004.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0005.png"   "/usr/share/plymouth/themes/charmander/throbber-0005.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0006.png"   "/usr/share/plymouth/themes/charmander/throbber-0006.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0007.png"   "/usr/share/plymouth/themes/charmander/throbber-0007.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0008.png"   "/usr/share/plymouth/themes/charmander/throbber-0008.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0009.png"   "/usr/share/plymouth/themes/charmander/throbber-0009.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0010.png"   "/usr/share/plymouth/themes/charmander/throbber-0010.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0011.png"   "/usr/share/plymouth/themes/charmander/throbber-0011.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0012.png"   "/usr/share/plymouth/themes/charmander/throbber-0012.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0013.png"   "/usr/share/plymouth/themes/charmander/throbber-0013.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0014.png"   "/usr/share/plymouth/themes/charmander/throbber-0014.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0015.png"   "/usr/share/plymouth/themes/charmander/throbber-0015.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0016.png"   "/usr/share/plymouth/themes/charmander/throbber-0016.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0017.png"   "/usr/share/plymouth/themes/charmander/throbber-0017.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0018.png"   "/usr/share/plymouth/themes/charmander/throbber-0018.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0019.png"   "/usr/share/plymouth/themes/charmander/throbber-0019.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0020.png"   "/usr/share/plymouth/themes/charmander/throbber-0020.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0021.png"   "/usr/share/plymouth/themes/charmander/throbber-0021.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0022.png"   "/usr/share/plymouth/themes/charmander/throbber-0022.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0023.png"   "/usr/share/plymouth/themes/charmander/throbber-0023.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0024.png"   "/usr/share/plymouth/themes/charmander/throbber-0024.png"
link_file "$BASE/plymouth/themes/charmander/throbber-0025.png"   "/usr/share/plymouth/themes/charmander/throbber-0025.png"
link_file "$BASE/plymouth/themes/charmander/watermark.png"       "/usr/share/plymouth/themes/charmander/watermark.png"

echo "All symlinks processed."

# ------------------------------------------------------------------
# Activate Plymouth theme (requires sudo)
# ------------------------------------------------------------------
echo "Setting Plymouth theme to charmander..."
sudo plymouth-set-default-theme charmander
sudo mkinitcpio -P
echo "Theme activated! Reboot to see it."

# ------------------------------------------------------------
# Finish
# ------------------------------------------------------------
echo
echo "Finished"

